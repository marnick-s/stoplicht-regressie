import R from"path";import U from"fs";import*as D from"child_process";var B=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function W(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var N,j;function $(){if(j)return N;j=1,N=s,s.sync=n;var e=U;function u(r,i){var a=i.pathExt!==void 0?i.pathExt:process.env.PATHEXT;if(!a||(a=a.split(";"),a.indexOf("")!==-1))return!0;for(var o=0;o<a.length;o++){var t=a[o].toLowerCase();if(t&&r.substr(-t.length).toLowerCase()===t)return!0}return!1}function l(r,i,a){return!r.isSymbolicLink()&&!r.isFile()?!1:u(i,a)}function s(r,i,a){e.stat(r,function(o,t){a(o,o?!1:l(t,r,i))})}function n(r,i){return l(e.statSync(r),r,i)}return N}var S,b;function M(){if(b)return S;b=1,S=u,u.sync=l;var e=U;function u(r,i,a){e.stat(r,function(o,t){a(o,o?!1:s(t,i))})}function l(r,i){return s(e.statSync(r),i)}function s(r,i){return r.isFile()&&n(r,i)}function n(r,i){var a=r.mode,o=r.uid,t=r.gid,c=i.uid!==void 0?i.uid:process.getuid&&process.getuid(),y=i.gid!==void 0?i.gid:process.getgid&&process.getgid(),p=parseInt("100",8),d=parseInt("010",8),v=parseInt("001",8),g=p|d,w=a&v||a&d&&t===y||a&p&&o===c||a&g&&c===0;return w}return S}var O,G;function q(){if(G)return O;G=1;var e;process.platform==="win32"||B.TESTING_WINDOWS?e=$():e=M(),O=u,u.sync=l;function u(s,n,r){if(typeof n=="function"&&(r=n,n={}),!r){if(typeof Promise!="function")throw new TypeError("callback not provided");return new Promise(function(i,a){u(s,n||{},function(o,t){o?a(o):i(t)})})}e(s,n||{},function(i,a){i&&(i.code==="EACCES"||n&&n.ignoreErrors)&&(i=null,a=!1),r(i,a)})}function l(s,n){try{return e.sync(s,n||{})}catch(r){if(n&&n.ignoreErrors||r.code==="EACCES")return!1;throw r}}return O}var C,I;function F(){if(I)return C;I=1;const e=process.platform==="win32"||process.env.OSTYPE==="cygwin"||process.env.OSTYPE==="msys",u=R,l=e?";":":",s=q(),n=o=>Object.assign(new Error(`not found: ${o}`),{code:"ENOENT"}),r=(o,t)=>{const c=t.colon||l,y=o.match(/\//)||e&&o.match(/\\/)?[""]:[...e?[process.cwd()]:[],...(t.path||process.env.PATH||"").split(c)],p=e?t.pathExt||process.env.PATHEXT||".EXE;.CMD;.BAT;.COM":"",d=e?p.split(c):[""];return e&&o.indexOf(".")!==-1&&d[0]!==""&&d.unshift(""),{pathEnv:y,pathExt:d,pathExtExe:p}},i=(o,t,c)=>{typeof t=="function"&&(c=t,t={}),t||(t={});const{pathEnv:y,pathExt:p,pathExtExe:d}=r(o,t),v=[],g=f=>new Promise((E,m)=>{if(f===y.length)return t.all&&v.length?E(v):m(n(o));const h=y[f],k=/^".*"$/.test(h)?h.slice(1,-1):h,x=u.join(k,o),T=!k&&/^\.[\\\/]/.test(o)?o.slice(0,2)+x:x;E(w(T,f,0))}),w=(f,E,m)=>new Promise((h,k)=>{if(m===p.length)return h(g(E+1));const x=p[m];s(f+x,{pathExt:d},(T,A)=>{if(!T&&A)if(t.all)v.push(f+x);else return h(f+x);return h(w(f,E,m+1))})});return c?g(0).then(f=>c(null,f),c):g(0)},a=(o,t)=>{t=t||{};const{pathEnv:c,pathExt:y,pathExtExe:p}=r(o,t),d=[];for(let v=0;v<c.length;v++){const g=c[v],w=/^".*"$/.test(g)?g.slice(1,-1):g,f=u.join(w,o),E=!w&&/^\.[\\\/]/.test(o)?o.slice(0,2)+f:f;for(let m=0;m<y.length;m++){const h=E+y[m];try{if(s.sync(h,{pathExt:p}))if(t.all)d.push(h);else return h}catch{}}}if(t.all&&d.length)return d;if(t.nothrow)return null;throw n(o)};return C=i,i.sync=a,C}var H=F();const L=W(H);async function V(e,u){const l=u==="x64"?"Win64":u==="x86"?"":null;if(l===null)return console.error("Failed to find valid VS gen, using native. Good Luck."),"native";const s=await _(`"${e}" -G`),r=s.includes(`\r
`)?s.split(`\r
`):s.split(`
`);let i=!1,a="";for(const t of r){if(!i&&t.trim()==="Generators"){i=!0;continue}const c=t.split("=");if(!(c.length<=1)&&(c[0]=c[0].replace(/^(\* )/,"").trim(),c[0].match(/Visual\s+Studio\s+\d+\s+\d+(\s+\[arch\])?/))){console.log("Found generator: ",c[0]),a=c[0];break}}return!a.match(/.*\[arch]/)?a+=" -A":a=a.replace("[arch]",l).trim(),a}function _(e){return new Promise(u=>{D.exec(e,(l,s,n)=>{u(s||n)})})}function K(e){return e.name===void 0&&(e.name=""),e.dev===void 0&&(e.dev=!1),e.os===void 0&&(e.os=process.platform,console.warn(`'os' was missing in the 'configurations'. Defaulting to the current operating system ${e.os}`)),e.arch===void 0&&(e.arch=process.arch,console.warn(`'arch' was missing in the 'configurations'. Defaulting to the current architecture ${e.arch}`)),e.runtime===void 0&&(e.runtime="node",console.warn("`runtime` was missing in the `configurations`. Defaulting to `node`")),e.runtimeVersion===void 0&&(e.runtimeVersion=process.versions.node,console.warn(`'runtimeVersion' was missing in the 'configurations'. Defaulting to the current runtimeVersion ${e.runtimeVersion}`)),e.toolchainFile===void 0&&(e.toolchainFile=null),e.CMakeOptions===void 0&&(e.CMakeOptions=[]),"cmakeOptions"in e&&e.cmakeOptions!==void 0&&console.warn("cmakeOptions was specified which was disabled in the 0.3.0 release. Please rename it to CMakeOptions"),e.addonSubdirectory===void 0&&(e.addonSubdirectory=""),e.additionalDefines=[],e}async function P(e){try{return await L(e)}catch{return null}}async function z(e,u){if(u.type==="nativeonly"&&(console.log(`--------------------------------------------------
      WARNING: Building only for the current runtime.
      WARNING: DO NOT SHIP THE RESULTING PACKAGE
     --------------------------------------------------`),e.configurations=[K({})]),u.type==="osonly"){console.log(`--------------------------------------------------
      WARNING: Building only for the current OS.
      WARNING: DO NOT SHIP THE RESULTING PACKAGE
     --------------------------------------------------`),e.configurations===void 0&&(console.error("No `configurations` entry was found in the package.json"),process.exit(1)),e.configurations=e.configurations.filter(n=>n.os===process.platform),e.configurations.length===0&&(console.error("No configuration left to build!"),process.exit(1));for(const n of e.configurations)n.toolchainFile=null}if(u.type==="dev-os-only"){console.log(`--------------------------------------------------
        WARNING: Building dev-os-only package
        WARNING: DO NOT SHIP THE RESULTING PACKAGE
       --------------------------------------------------`),e.configurations===void 0&&(console.error("No `configurations` entry was found in the package.json"),process.exit(1));const n=e.configurations.find(r=>r.os===process.platform&&r.dev);n===void 0&&(console.error(`No matching entry with \`dev == true\` and \`os == ${process.platform}\` in \`configurations\``),process.exit(1)),e.configurations=[n]}if(u.type==="named-configs"&&(e.configurations===void 0&&(console.error("No `configurations` entry was found in the package.json"),process.exit(1)),e.configurations=e.configurations.filter(n=>n.name!==void 0?u.configsToBuild.includes(n.name):!1),e.configurations.length===0&&(console.error("No configuration left to build!"),process.exit(1))),e.packageDirectory===void 0&&(e.packageDirectory=process.cwd()),e.projectName===void 0&&(e.projectName="addon"),e.targetDirectory===void 0&&(e.targetDirectory="build"),e.stagingDirectory===void 0&&(e.stagingDirectory="staging"),e.cmakeToUse===void 0){const n=await P("cmake");n===null&&(console.error("cmake binary not found, try to specify 'cmakeToUse'"),process.exit(1)),e.cmakeToUse=n}const[l,s]=await Promise.all([P("ninja"),P("make")]);if(e.generatorToUse===void 0)if(console.log("no generator specified in package.json, checking ninja"),l===null)if(console.log("ninja not found, checking make"),s===null)if(console.log("make not found, using native"),process.platform==="win32"){const n=await V(e.cmakeToUse,process.arch);e.generatorToUse=n,e.generatorBinary="native"}else e.generatorToUse="native",e.generatorBinary="native";else console.log("found make at",s,"(fallback)"),e.generatorToUse="Unix Makefiles",e.generatorBinary=s;else console.log("found ninja at",l),e.generatorToUse="Ninja",e.generatorBinary=l;if(e.generatorBinary===void 0&&(e.generatorToUse==="Ninja"?(l===null&&(console.error("Ninja was specified as generator but no ninja binary could be found. Specify it via 'generatorBinary'"),process.exit(1)),e.generatorBinary=l):e.generatorToUse==="Unix Makefiles"?(s===null&&(console.error("Unix Makefiles was specified as generator but no make binary could be found. Specify it via 'generatorBinary'"),process.exit(1)),e.generatorBinary=s):(console.error(`Unsupported generator ${e.generatorToUse}`),process.exit(1))),e.buildType===void 0&&(e.buildType="Release",console.warn("`buildType` was missing. Considering 'Release'")),e.configurations)for(const n of e.configurations)n.additionalDefines=[];return e}export{K as defaultBuildConfiguration,z as defaultBuildOptions};
//# sourceMappingURL=lib.mjs.map
